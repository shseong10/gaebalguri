<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        " http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.icia.seong.dao.InventoryDao">
    <!-- 상품 등록 -->
    <insert id="addItemSelectKey" parameterType="InventoryDto" useGeneratedKeys="true" keyProperty="h_p_num">
        insert into h_product (h_p_name, h_p_category, h_p_price, h_p_quantity, h_p_desc, h_p_date, h_p_enddate, h_p_buylevel)
        values (#{h_p_name}, #{h_p_category}, #{h_p_price}, #{h_p_quantity}, #{h_p_desc}, default, #{h_p_enddate}, default)
        <selectKey keyProperty="h_p_num" resultType="Integer" order="AFTER">
            select last_insert_id()
        </selectKey>
    </insert>
    <!-- 상품 이미지 첨부 -->
    <insert id="fileInsertMap" parameterType="HashMap">
        insert into h_p_image
        values(null, #{h_p_num}, #{oriFileName},#{sysFileName})
    </insert>
    <!-- 상품 카테고리 선택 옵션 -->
    <select id="getCategoryList"  resultType="CategoryDto">
        select c_name from h_category
    </select>
    <!-- 상품 수정 -->
    <update id="updateItem">
        update h_product set h_p_name = #{h_p_name}, h_p_category = #{h_p_category}, h_p_price = #{h_p_price},
        h_p_quantity = #{h_p_quantity}, h_p_desc = #{h_p_desc}, h_p_date = default, h_p_enddate = #{h_p_enddate}, h_p_buylevel = #{h_p_buylevel}
        where h_p_num = #{h_p_num}
    </update>
    <!-- 목록 출력 -->
    <resultMap type="InventoryDto" id="ifList">
        <id property="h_p_num" column="h_p_num" />
        <result property="h_p_name" column="h_p_name" />
        <result property="h_p_category" column="h_p_category" />
        <result property="h_p_price" column="h_p_price" />
        <result property="h_p_quantity" column="h_p_quantity" />
        <result property="h_p_desc" column="h_p_desc" />
        <result property="h_p_enddate" column="h_p_enddate" />
        <result property="h_p_enddateString" column="h_p_enddateString" />
        <result property="h_p_buylevel" column="h_p_buylevel" />
        <collection property="ifList" javaType="ArrayList" ofType="InventoryFile">
            <result property="h_p_oriFileName" column="h_p_oriFileName" />
            <result property="h_p_sysFileName" column="h_p_sysfilename" />
        </collection>
    </resultMap>
    <select id="getInventoryList" parameterType="HashMap" resultMap="ifList" resultType="InventoryDto">
        select h_p_num, h_p_name, h_p_price, h_p_desc, h_p_category, h_p_quantity, h_p_enddate, h_p_buylevel,
        date_format(h_p_enddate,'%Y-%m-%d %H:%i') h_p_enddateString,
        h_p_orifilename, h_p_sysfilename
        from h_product left join h_p_image
        on h_p_num=h_p_pnum order by h_p_num desc
        limit
        #{startIdx}, #{listCnt}
    </select>
    <!-- 관리자 페이지 보기 -->
    <select id="getAdmin" parameterType="HashMap" resultMap="ifList" resultType="InventoryDto">
        select h_p_num, h_p_name, h_p_price, h_p_desc, h_p_category, h_p_quantity, h_p_enddate, h_p_buylevel,
        date_format(h_p_enddate,'%Y-%m-%d %H:%i') h_p_enddateString,
        h_p_orifilename, h_p_sysfilename
        from h_product left join h_p_image
        on h_p_num=h_p_pnum order by h_p_num desc
        limit
        #{startIdx}, #{listCnt}
    </select>
    <!-- 상품 상세 보기 -->
    <select id="getInventoryDetail" parameterType="Integer" resultMap="ifList">
        select h_p_num, h_p_name, h_p_price, h_p_desc, h_p_category, h_p_quantity, h_p_enddate, h_p_buylevel,
        date_format(h_p_enddate,'%Y-%m-%d %H:%i') h_p_enddateString,
        h_p_orifilename, h_p_sysfilename
        from h_product left join h_p_image
        on h_p_num=h_p_pnum
        where h_p_num=#{h_p_num}
    </select>
    <!-- 상품 상세 보기 -->
    <select id="getQuickView" parameterType="Integer" resultMap="ifList">
        select h_p_num, h_p_name, h_p_price, h_p_desc, h_p_category, h_p_quantity, h_p_enddate, h_p_buylevel,
        date_format(h_p_enddate,'%Y-%m-%d %H:%i') h_p_enddateString,
        h_p_orifilename, h_p_sysfilename
        from h_product left join h_p_image
        on h_p_num=h_p_pnum
        where h_p_num=#{h_p_num}
    </select>
    <!-- 관리자 상품 빠른 수정-->
    <update id="quickUpdate" parameterType="InventoryDto">
        update h_product set h_p_name = #{h_p_name}, h_p_category = #{h_p_category}, h_p_price = #{h_p_price},
        h_p_quantity = #{h_p_quantity}, h_p_desc = #{h_p_desc}, h_p_date = default, h_p_enddate = #{h_p_enddate}, h_p_buylevel = #{h_p_buylevel}
        where h_p_num = #{h_p_num}
    </update>
    <select id="getInventoryCount" parameterType="SearchDto" resultType="int">
        select count(*) from h_product
        <if test="colName!=null">
            where ${colName} like concat('%',#{keyword},'%')
        </if>
    </select>
</mapper>